# Use zsh (on some machines tmux will try bash).
set-option -g default-shell /bin/zsh

# -------------------------------------------------------------------
# Plugins
# -------------------------------------------------------------------
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Session persistence: auto-save every 15min, auto-restore on tmux start
set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# -------------------------------------------------------------------
# Pane splitting
# -------------------------------------------------------------------
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# New windows also inherit current path
bind c new-window -c "#{pane_current_path}"

# -------------------------------------------------------------------
# Terminal: true colour support
# -------------------------------------------------------------------
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"

# -------------------------------------------------------------------
# Mouse — keep on for pane resize/scroll, but make text selection easy
# -------------------------------------------------------------------
set -g mouse on

# Copy on mouse-drag release (no need to press y)
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-and-cancel

# Shift+click bypasses tmux entirely — use for clicking links in Kitty
# (This is automatic in most terminals: hold Shift to bypass tmux mouse)

# -------------------------------------------------------------------
# Vi copy mode
# -------------------------------------------------------------------
setw -g mode-keys vi
bind Enter copy-mode
bind -T copy-mode-vi v   send-keys -X begin-selection
bind -T copy-mode-vi V   send-keys -X select-line
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y   send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi /   command-prompt -i -p "search down" "send -X search-forward-incremental \"%%%\""
bind -T copy-mode-vi ?   command-prompt -i -p "search up" "send -X search-backward-incremental \"%%%\""

# -------------------------------------------------------------------
# Copy-mode colours — sourcerer palette
# -------------------------------------------------------------------
set -g mode-style "fg=#c2c2b0,bg=#444444"
set -g copy-mode-match-style "fg=#111111,bg=#d7875f"
set -g copy-mode-current-match-style "fg=#111111,bg=#a88af8,bold"

# -------------------------------------------------------------------
# Pane zoom (prefix + z is default, prefix + m as alias)
# -------------------------------------------------------------------
bind m resize-pane -Z

# -------------------------------------------------------------------
# Pane resize (arrow keys — disabled in vim, free in tmux)
# -------------------------------------------------------------------
bind -r Up    resize-pane -U 5
bind -r Down  resize-pane -D 5
bind -r Left  resize-pane -L 5
bind -r Right resize-pane -R 5

# Fine-grained resize with shift
bind -r S-Up    resize-pane -U 1
bind -r S-Down  resize-pane -D 1
bind -r S-Left  resize-pane -L 1
bind -r S-Right resize-pane -R 1

# -------------------------------------------------------------------
# Quick session switching (fzf-powered)
# -------------------------------------------------------------------
bind s display-popup -E -w 60% -h 60% "\
    tmux list-sessions -F '#{session_name}' \
    | fzf --reverse --header='Switch session' \
           --preview='tmux capture-pane -t {} -p -S -20' \
    | xargs tmux switch-client -t"

# -------------------------------------------------------------------
# Respawn dead panes
# -------------------------------------------------------------------
bind R respawn-pane -k

# -------------------------------------------------------------------
# Pane borders — sourcerer palette
# -------------------------------------------------------------------
set -g pane-border-style "fg=#333333"
set -g pane-active-border-style "fg=#a88af8"
set -g pane-border-lines heavy

# -------------------------------------------------------------------
# Status bar — sourcerer-inspired
# -------------------------------------------------------------------
set -g status-position top
set -g status-style "fg=#918175,bg=#1a1a1a"
set -g status-interval 5

# Left: session name with purple accent
set -g status-left-length 30
set -g status-left "#[fg=#111111,bg=#a88af8,bold] #S #[fg=#a88af8,bg=#1a1a1a]"

# Right: git branch | short hostname | time
set -g status-right-length 120
set -g status-right "#[fg=#87af87]#(cd #{pane_current_path} && git rev-parse --abbrev-ref HEAD 2>/dev/null || echo '-') #[fg=#444444]| #[fg=#c2c2b0]#h #[fg=#444444]| #[fg=#a88af8]%H:%M"

# Window tabs — dim inactive, purple active, activity indicator
set -g window-status-format "#[fg=#666666] #I:#W#F "
set -g window-status-current-format "#[fg=#111111,bg=#a88af8,bold] #I:#W#F "
set -g window-status-activity-style "fg=#d7875f"
set -g window-status-separator ""

# Message/command line styling
set -g message-style "fg=#c2c2b0,bg=#2a2a2a"
set -g message-command-style "fg=#c2c2b0,bg=#2a2a2a"

# Popup styling
set -g popup-border-style "fg=#a88af8"
set -g popup-border-lines rounded

# Clock mode
set -g clock-mode-colour "#a88af8"
set -g clock-mode-style 24

# -------------------------------------------------------------------
# Window behaviour
# -------------------------------------------------------------------
# Auto-rename windows to running command
setw -g automatic-rename on
setw -g automatic-rename-format "#{b:pane_current_path}"

# Renumber windows when one is closed (no gaps)
set -g renumber-windows on

# Activity monitoring (subtle — just highlights the tab)
setw -g monitor-activity on
set -g visual-activity off

# -------------------------------------------------------------------
# Smart pane switching with awareness of Vim splits
# See: https://github.com/christoomey/vim-tmux-navigator
# -------------------------------------------------------------------
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n C-h if-shell "$is_vim" "send-keys C-h"  "select-pane -L"
bind-key -n C-j if-shell "$is_vim" "send-keys C-j"  "select-pane -D"
bind-key -n C-k if-shell "$is_vim" "send-keys C-k"  "select-pane -U"
bind-key -n C-l if-shell "$is_vim" "send-keys C-l"  "select-pane -R"
bind-key -n C-\\ if-shell "$is_vim" "send-keys C-\\" "select-pane -l"
bind-key -T copy-mode-vi C-h select-pane -L
bind-key -T copy-mode-vi C-j select-pane -D
bind-key -T copy-mode-vi C-k select-pane -U
bind-key -T copy-mode-vi C-l select-pane -R
bind-key -T copy-mode-vi C-\\ select-pane -l

# -------------------------------------------------------------------
# General
# -------------------------------------------------------------------
set -g history-limit 50000
set-option -sg escape-time 10
set-option -g focus-events on

# Keep environment variables on reattach (SSH agent, AWS creds)
set -g update-environment "SSH_AUTH_SOCK SSH_CONNECTION SSH_AGENT_PID DISPLAY AWS_PROFILE AWS_DEFAULT_REGION"

# -------------------------------------------------------------------
# Initialize TPM (keep at the very bottom)
# -------------------------------------------------------------------
run '~/.tmux/plugins/tpm/tpm'
