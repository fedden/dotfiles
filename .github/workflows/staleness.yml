name: Check for outdated packages

on:
  schedule:
    # Weekly on Mondays at 09:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch: {}

permissions:
  issues: write

jobs:
  check-staleness:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run install script
        run: ./install.sh
        env:
          NONINTERACTIVE: 1

      - name: Check for outdated packages
        id: check
        run: |
          report=""

          echo "=== Brew ==="
          outdated=$(brew outdated --verbose 2>/dev/null || true)
          if [[ -n "$outdated" ]]; then
            report+="## Brew packages\n\n\`\`\`\n${outdated}\n\`\`\`\n\n"
          fi

          echo "=== Rust ==="
          source "$HOME/.cargo/env" 2>/dev/null || true
          rust_check=$(rustup check 2>/dev/null || true)
          if echo "$rust_check" | grep -q "Update available"; then
            report+="## Rust\n\n\`\`\`\n${rust_check}\n\`\`\`\n\n"
          fi

          echo "=== Claude Code ==="
          export NVM_DIR="$HOME/.nvm"
          if [[ -s "$NVM_DIR/nvm.sh" ]]; then source "$NVM_DIR/nvm.sh"; fi
          cc_outdated=$(npm outdated -g @anthropic-ai/claude-code 2>/dev/null || true)
          if [[ -n "$cc_outdated" ]]; then
            report+="## Claude Code\n\n\`\`\`\n${cc_outdated}\n\`\`\`\n\n"
          fi

          echo "=== Neovim plugins ==="
          plugin_output=$(nvim --headless "+Lazy! sync" +qa 2>&1 || true)
          updated_count=$(echo "$plugin_output" | grep -c "Updated" || true)
          installed_count=$(echo "$plugin_output" | grep -c "Installed" || true)
          if [[ "$updated_count" -gt 0 || "$installed_count" -gt 0 ]]; then
            report+="## Neovim plugins\n\n${updated_count} plugin(s) updated, ${installed_count} plugin(s) newly installed.\n\n"
          fi

          echo "=== Tool versions ==="
          versions="| Tool | Version |\n|------|--------|\n"
          versions+="| nvim | $(nvim --version | head -1) |\n"
          versions+="| tmux | $(tmux -V) |\n"
          versions+="| rg | $(rg --version | head -1) |\n"
          versions+="| fzf | $(fzf --version | head -1) |\n"
          versions+="| fd | $(fd --version) |\n"
          versions+="| eza | $(eza --version | head -1) |\n"
          versions+="| bat | $(bat --version) |\n"
          versions+="| starship | $(starship --version) |\n"
          versions+="| uv | $(uv --version 2>/dev/null || echo 'not found') |\n"
          if [[ -s "$NVM_DIR/nvm.sh" ]]; then
            versions+="| node | $(node --version 2>/dev/null || echo 'not loaded') |\n"
          fi
          versions+="| rustc | $(rustc --version 2>/dev/null || echo 'not found') |\n"

          if [[ -n "$report" ]]; then
            echo "has_updates=true" >> "$GITHUB_OUTPUT"
            {
              echo "report<<STALENESS_EOF"
              echo -e "$report"
              echo -e "## Current versions\n\n$versions"
              echo "STALENESS_EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
            echo "Everything is up to date."
          fi

      - name: Create or update issue
        if: steps.check.outputs.has_updates == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          title="Outdated packages detected"
          # Close any existing staleness issues
          existing=$(gh issue list --label "staleness" --state open --json number -q '.[].number' 2>/dev/null || true)
          for num in $existing; do
            gh issue close "$num" --comment "Superseded by new staleness check."
          done

          body="$(cat <<'ISSUE_EOF'
          ${{ steps.check.outputs.report }}

          ---

          Run `./update.sh` locally to update everything, or update individual tools as needed.

          _Auto-generated by the weekly staleness check._
          ISSUE_EOF
          )"

          gh issue create \
            --title "$title" \
            --body "$body" \
            --label "staleness"
